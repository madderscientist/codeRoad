# 多功能钟
2023 SEU 暑期学校 数字系统设计 课程设计<br>
VIVADO 2020.1, 用verilog写钟2.0

## 概述
设计FPGA模块模拟多功能电子表的工作过程，具有多种功能，功能如下<br>
（1）	时间显示界面，要求从00：00点计到23：59。<br>
（2）	日期显示界面，要求显示当前日期，包含年、月、日。<br>
（3）	调整时间界面，即可以设置或更改当前的时间（小时、分）。 <br>
（4）	日期设置界面。可以设置当前的日期，比如2020年09月22日。要求支持闰年与大小月的识别。<br>
（5） 闹钟设置界面，可以设置3个闹钟，闹钟时间到了后会用LED闪烁提醒，提醒时间持续5秒，如果提醒时按解除键，则该闹钟解除提醒，如果闹钟响时没有按键或按其他按键，则响完5秒之后暂停，然后10秒钟后重新提醒一次后解除。<br>
（6） 倒计时功能。可以设定倒计时的起始时间，比如1分钟，然后开始倒计时，从01:00倒计时到00:00，然后LED灯闪烁5秒钟。倒计时中间可以暂停或重新开始。<br>
（7） 电子表只有六个按键。请只使用六个按键来完成所有功能。

## 链接
更多信息详见[设计时笔记](/powerClock/powerClock.srcs/sources_1/new/数字系统设计.md)<br>
信息学院一群卷怪，想骂人。要不是他们，我也不会加蓝牙模块，写配套APP，加OLED显示。<br>
APP: 用appinventor2极速开发，[下载](./APK/powerClock.apk)，放入了aia文件供学习

## 心得
第一次烧写FPGA。总结下来技术性的收获有以下几点：
1. 上升沿读取状态并执行一些操作，下降沿更新状态，能有效避免玄学问题。
2. 不要在多个always中对一个reg赋值。如果要实现一个影响一个再影响一个，可以用的框架是：某一个always中CLK每个上升沿读取相关信号状态，并对某个reg进行操作。下降沿来判断是否有沿或者更新状态。比如我在在UART里面用的。
3. 承上，最好在每个CLK边沿判断，而不是别的什么触发信号触发什么操作。当然后者能一定程度上简化代码，减少耦合，减轻硬件负担；但是前者适合大规模的项目，避免了复杂的连接关系和时序关系。
3. 沿判断电路：两个reg，一个保存之前的，一个保存当前采样的，然后两者之间组合逻辑运算可以得到什么沿。
```verilog
reg signal_prev, signal_now;
always @(negedge CLK) begin     // 下降沿更新状态
    signal_prev <= singal_now;
    signal_now <= signal;
end
wire signal_pos = ~signal_prev & signal_now;  // 上升沿
wire signal_neg = signal_prev & ~signal_now;  // 下降沿
```
5. 脉冲产生电路：原理同上，要产生脉冲只要翻转reg即可，注意延迟
```verilog
reg pulse_cache, pulse_generator;
always @(negedge CLK) begin     // 下降沿同步置零脉冲信号
    pulse_cache <= pulse_generator;
end
wire pulse = pulse_generator ^ pulse_cache;   // 脉冲信号
// 使用时：
pulse_generator <= ~pulse_generator;
```

## 不足
设计时思路被板子上仅有的5个按钮局限了，导致后续写app时无法拓展其功能，只能模拟板子上的按钮，相当于一个遥控器（不然可以加网络时钟校准等）。一开始未了解到上面的这些设计框架，核心部分的计数器用的还是之前写钟的方法（即不依赖CLK更新，只依赖进位的上升沿），虽然硬件简单，但难以拓展，且需要额外考虑诸如长脉冲转短脉冲等细节。<br>
如果现在重新设计，我不会再把十位个位分开，直接按照写日历的月日的方法用case将二进制映射为两位BCD。这样能避免很多问题，而且功能易于拓展。

## 遗憾
身边没有VGA的显示器，只有HDMI便携屏。写过VGA输出，但用VGA转HDMI但屏幕不亮。发现我的屏幕分辨率只能1920*1080@60，用PLL倍频改参数还是无济于事。问题可能出在很多地方，比如显示器、转接口、程序。没有VGA屏幕，难以排查问题，故没有继续下去。

<br>
其他全写报告里面了。见“报告.pdf”