# 功能电子表数字系统设计

## 目的
掌握数字系统的FPGA实现，熟练使用Verilog、Vivado、FPGA等工具；
在实践中总结FPGA编程特点，积累硬件编程思路框架。

## 任务
设计FPGA模块模拟多功能电子表的工作过程，具有多种功能，功能如下：
（1）时间显示界面，要求从00：00点计到23：59。
（2）日期显示界面，要求显示当前日期，包含年、月、日。
（3）调整时间界面，即可以设置或更改当前的时间（小时、分）。
（4）日期设置界面。可以设置当前的日期，比如2020年09月22日。要求支持闰年与大小月的识别。
（5）闹钟设置界面，可以设置3个闹钟，闹钟时间到了后会用LED闪烁提醒，提醒时间持续5秒，如果提醒时按解除键，则该闹钟解除提醒，如果闹钟响时没有按键或按其他按键，则响完5秒之后暂停，然后10秒钟后重新提醒一次后解除。
（6）倒计时功能。可以设定倒计时的起始时间，比如1分钟，然后开始倒计时，从01:00倒计时到00:00，然后LED灯闪烁5秒钟。倒计时中间可以暂停或重新开始。
（7）电子表只有六个按键。请只使用六个按键来完成所有功能。

## 原理图
特色功能：小时12/24进制切换、闹钟启用控制、用声音提醒、UI提示、OLED显示、手机APP控制
总图：【一张抽象的原理图】【一张RTL级别的综合的原理图】
- 设计难点：
### 1. 计数器
计数器的设计决定了整个项目的结构。由于设计较早，因此事后觉得此设计拖累了项目。此处暂且抛开其优劣不谈。
设计时将一个数字分为了十位和个位两个计数器，以实现模块化。由上一级的计数器的进位充当下一位的时钟位。
【计数器原理图】
#### 最值与清零
小时是满24清零，日期的最大值和月份、年份相关，月是满12清零。
解决方法：小时使用了特殊的计数器：传入一个MAX值和刷新时钟、刷新使能信号。在刷新使能位为1时，在刷新时钟的边沿将计数器的值按照MAX更新为范围内的值。而对于日期、月份，个位不仅有变化的最大值，还有最小值，比如日期从01号开始而不是00号。再用之前的方法会很复杂。于是将两位并成一个模块，加10或加1，并判断范围。保留了刷新时钟和刷新使能，因为基本原理还是进位充当时钟。
#### 脉冲化
根据画出的原理图，这样的设计(计数器的CLK由上一个计数器进位的上升沿充当)有一个缺陷：计数器的进位脉冲宽度和驱动其的CLK周期相同。如果该计数器表示小时，那么它的进位将1小时更新一次，即其进位的高电平将保持一个小时。
如果只是计时，这样可以满足要求。但是需要自己设置时间，意味着寄存器的更新还要能通过按钮的脉冲(称为ADD)控制。由原理图知，实际更新寄存器信号是用复用器选择的CLK和ADD之一。问题来了，如果在CLK长达1小时的高电平期间，切换到ADD信号，再切换回去，就会多出一个上升沿，导致计数器无辜+1。因为由于ADD是按钮脉冲，故大多时候为低电平。如果在ADD为低电平的时候离开设置模式，即切换回长达1小时高电平的CLK信号，就会产生上升沿。因此，需要设计一个上升沿转脉冲的模块。

### 2. 报警
设计了一个负反馈回路。当闹钟响了，会发出一个短脉冲，状态机进入报警状态，其输出的报警电平启动时间管理模块的计时，计时到后向状态机发送停止信号，使报警电平归零。而题目要求的比如“响5秒停10秒再响5秒”由时间管理模块输出的高低电平表示，再去控制喇叭。


## 状态机流程图
【图】
状态机功能概述：
1. 分为6个界面，对应要求的6个功能。
2. 每个界面有两个基本状态：设置态和预设态，设置态又有9个子态。用8位的独热码SET表示当前页面的设置情况。设置时8位仅有一位为1，表示对应数正在被设置。有一个信号set控制SET是否为0（进入/退出设置模式），有另一个信号left控制SET左移。

|SET|含义|
|---|----|
|00000000|不在设置中(预设态)|
|00000001|正在设置第一位|
|00000010|正在设置第二位|
|00000100|正在设置第三位|
|...|以此类推|

3. 还有一个服务于UI的状态量SELECT，表示当前正在显示/操作哪一个功能界面。有一个信号next控制此数+1。

|SELECT|功能|
|------|----|
| 000  |时钟|
| 001  |日期|
| 010  |闹钟1|
| 011  |闹钟2|
| 100  |闹钟3|
| 101  |倒计时|

4. 而闹钟和倒计时由于自身特殊的功能，有自己的独特的状态：报警态。有一个信号alarming控制进入报警态，其他所有信号控制退出报警态（按任意键解除）。进入报警态优先级最高，可以跨功能跳转到此态。
5. 倒计时有“倒计时态(正在)”和“倒计时态(停止)”，统称“倒计时态”。从实际使用考虑，倒计时态不能直接到设置态，因此复用了设置模式的信号，如果在倒计时态，set信号表示到预设态，而不是直接到设置态。此外，还有一个信号start控制进入倒计时态和倒计时子态的切换。

## 输入情况波形情况(文字解释)

## 实拍结果

## 分工
龙艺文同学完成了OLED的显示和倒计时模块的编写，且负责大部分文案工作。其余由李睿刚同学完成。

## 总结
各写各的

## 附录（源程序）
见程序文件