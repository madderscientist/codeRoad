# STM32F407驱动OV7670(with FIFO)摄像头和ST7735屏幕
2024/3/9 - 2024/3/10 把czj淘汰的ov7670盘活了。天气大好，却窝在宿舍码了两天。<br>
前人栽树，后人的活轻松了不少。他的项目有花屏的摄像头和屏幕驱动函数。

## how to use
硬件资源如标题所示。文件夹中压缩了cubeMX自动生成的代码，解压后可直接使用。摄像头的接线需要对照cubeMX的配置接线，引脚参考[队友的笔记](./color/czj's work.md)。如需更改引脚，请注意GPIO的方向和速度和命名。

## 配置好了摄像头
之前czj没配置好可能是上拉不够。在配置I2C内部上拉的同时，我给SDA和SCLK加上了额外的上拉（焊接了两个4.7kΩ贴片）。<br>
配置上，开启了自动曝光和自动白平衡。<br>
注意I2C的速度不能快，快了屏幕就花。400k会挂，100k即可。<br>

## 屏幕驱动
将绘图和屏幕驱动分开了。屏幕驱动的函数保留了C风格，因为宏定义太多了，抽象成类没有意义。<br>
屏幕驱动函数的数组从全局变量变为传参，以实现和绘图功能的解耦。<br>
将屏幕数据发送拆成三个部分：准备发送、发送、结束发送，因为屏幕数据可以分批发送。如果内存资源很紧张，可以不必创建整个大小的图像数组，而是用小数组实现分块接收、显示。在下文的Channel类就用了这样的方法。<br>

## 完成了适配屏幕的图像库
czj写的图像函数太烂了，效率低下还会越界。重新写了几个。<br>
图像库有两个版本，版本一是pixmap_singleClass.hpp，独立类，具体功能见下。<br>
版本二是imgArray.hpp、channel.hpp、pixmap.hpp，用类继承封装了一下，其中：

- ImgArray（imgArray.hpp）是基类，定义了基本的数据结构，提供了一些泛用的api。后面两个都继承自它。
- U8Drawer（pixmap.hpp）操作的是屏幕所使用的数据格式，此类屏蔽了底层“两个字节是一个像素”的信息，提供了绘制彩色图形的API。优点是数组所存即屏幕所需、摄像头所给，可以直接接收摄像头的数据、直接发送给屏幕。类似html的canvas（绘图为主）。
- Channel（channel.hpp）是8bit单通道的图像，一般用于灰度处理。内置了和RGB565的转换函数，可以直接从摄像头获取（获取rgb565数据时转换）灰度值、自动转换为屏幕所需格式（分批转换为rgb565并发送）。优点是占据内存小，数据格式简明。没有实现绘制的API，而主要聚焦于图像处理，比如二值化和卷积。类似html从canvas获取的ImageData（像素处理为主）。

## C++化
全面使用C++编程。每次从cube生成代码后，请从main.c中复制新增代码，并在keil中删除mian.c（只留main.cpp）。<br>
hpp文件导入的时候需要选择text document文件（和.h一个类型），虽然可以不添加进项目，但是建议当.cpp对待。<br>
项目配置不要勾选microLIB。

## 遇到的坑
### 有关宏定义

```cpp
#define ABS(x) ((x) > 0 ? (x) : (-x))
int32_t y0 = 128;
int32_t y1 = 64;
int32_t dy = -ABS(y1 - y0);
```

单片机上得到的结果是dy=192，在电脑上跑结果是正确的。因为展开后变成了“:(-y1-y0)”。正确写法：

```cpp
#define ABS(x) ((x) > 0 ? (x) : -(x))
```

为什么在电脑上跑是对的？因为单片机上其实有两个ABS的定义：

```cpp
// main.h中
#define ABS(x) ((x) > 0 ? (x) : (-x))
// 出问题的文件中
#ifndef ABS
#define ABS(x) ((x) > 0 ? (x) : -(x))
#endif
```

于是正确的写法被pass了……而复制到电脑上运行只复制了出问题的文件。

### 有关堆空间
在实现卷积的时候用new分配了大概323byte的空间，虽然分配成果（分配后指针不是nullptr），但是无法修改此空间的内容（即使赋值了）。只有分配小空间才正常。原因是堆空间太小。可以在cubemx中配置堆大小，我从0x200加到了0x300，才能正常使用。根据网上的经验，用户能用的堆空间只有分配的一半左右。<br>
由于堆空间非常紧张，所以图像类构造函数中用new分配空间的操作一定会爆堆，所以应该先在flash中先创建数组（写成全局变量），然后传参给构造函数（见main.cpp）。

## 嘱托
main.cpp中使用了版本二，提供了两个类的使用，目前保留了Channel类，实现了边缘提取。<br>
如果不需要图像处理（或者只需要彩图、只需要显示摄像头数据并圈圈点点），可以把三个文件删了，引入pixmap_singleClass.hpp（删版本二用版本一）。对于czj的项目，只用版本一即可。没有继承的版本一开销会小一些。